{% extends 'base.html.twig' %}

{% block body %}

<div class="container-fluid">
    <br>
    <div class="row">
        <div class="col-3"></div>
        <div class="col-6">
            {% if app.user %}
            <p style="text-align:center;">Bonjour,
                <span style="font-weight:bold;font-size:20px;text-align:center;">

                    {{ app.user.username }}</span>
                !</p>
            {% endif %}
        </div>
        <div class="col-3"></div>
    </div>

    <div class="row">

        <div class="col-3">
            <div class="bloc-gauche">
                <p style="text-align:center;"><br>
                   Quelle catégorie souhaite tu voir ? <br>
                   {% for category in categories %}

            <a class="nav-item" href="{{path ('show_category', {'id' : category.id })}}">{{ category.title }}</a>

            {% endfor %}
                </p>

            </div>
        </div>
        <div class="col-6">
            {% for activity in activities %}
            <div class="card">
                {% for picture in activity.pictures %}
                {% if loop.index0 == 0 %}
                <img class="card-img-top" src="{{ asset('uploads/pictures/' ~ picture.url) }}" alt="{{picture.legende}}"
                    style="width:30%; height:30%;">
                {% endif %}
                {% endfor %}
                <div class="card-body">
                    <h5 class="card-title">
                        <a class="activity-title" href="{{path ('show_activity', {'id' : activity.id })}}">{{
                            activity.title }}</a>
                    </h5>
                    <p class="card-text">
                        {{ activity.description |raw}}</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        {{ activity.createdAt|date('d-m-Y') }}
                        Dans la catégorie
                        {{ activity.category.title }}
                        
                        <a href="{{path ('like', {'id' : activity.id })}}" class="btn btn-link js-like">
                            {% if app.user and activity.isLikeByUser(app.user) %}
                            <i class="fas fa-heart"></i> 
                            {% else %}
                            <i class="far fa-heart"></i> 
                            {% endif %}
                            
                            <span class="js-likes"> {{ activity.likes | length }}  </span>
                            <span class="js-label"> J'aime </span>
                        </a></small>
                </div>
            </div>
            <br>
            {% endfor %}
        </div>

        <div class="col-3">
            <div class="bloc-utilisateur">
                {% if app.user %}
                <p style="text-align:center;">Bonjour,
                    <span style="font-weight:bold;font-size:20px;text-align:center;">

                        {{ app.user.username }}</span>
                    !</p>
                {% endif %}
                <br><br><br><br>
            </div>
        </div>

    </div>
    <div class="navigation">
        {{ knp_pagination_render(activities) }}
    </div>

</div>

{% endblock %}

{% block javascripts %}
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        function onClickBtnLike(event){
            event.preventDefault();
            const url = this.href;
            const spanCount = this.querySelector('span.js-likes');
            const icone = this.querySelector('i');

            axios.get(url).then(function(response) {
                spanCount.textContent = response.data.likes;
                if(icone.classList.contains('fas')){
                    icone.classList.replace('fas', 'far');
                }else{
                    icone.classList.replace('far', 'fas');
                }
            }).catch(function(error) {
                if(error.response.status === 403) {
                    window.alert("Vous ne pouvez pas liker un article si vous n'êtes pas connecté");
                } else{ 
                    window.alert("Une erreur s'est produite");
                }
            });
        }

        document.querySelectorAll('a.js-like').forEach(function(link) {
            link.addEventListener('click', onClickBtnLike);
        })
    </script>
{% endblock %}